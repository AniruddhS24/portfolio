---
import { getCollection } from "astro:content";
import { getConfigurationCollection } from "../../lib/utils";

const { data: config } = await getConfigurationCollection();

// Fetch all content at build time
const projects = (await getCollection("project")).sort(
  (a, b) => b.data.timestamp.valueOf() - a.data.timestamp.valueOf()
);
const blogs = (await getCollection("blog")).sort(
  (a, b) => b.data.timestamp.valueOf() - a.data.timestamp.valueOf()
);
const research = (await getCollection("research")).sort(
  (a, b) => b.data.timestamp.valueOf() - a.data.timestamp.valueOf()
);

// Build content index with IDs
const contentIndex = {
  projects: projects.map((p, i) => ({
    id: `P${i + 1}`,
    title: p.data.title,
    description: p.data.description,
    tags: p.data.tags || [],
    url: `/projects/${p.data.slug}`,
    githubUrl: p.data.githubUrl,
  })),
  blogs: blogs.map((b, i) => ({
    id: `B${i + 1}`,
    title: b.data.title,
    description: b.data.description,
    tags: b.data.tags || [],
    url: `/blog/${b.data.slug}`,
  })),
  research: research.map((r, i) => ({
    id: `R${i + 1}`,
    title: r.data.title,
    authors: r.data.authors,
    venue: r.data.venue,
    paperUrl: r.data.paperUrl,
    codeUrl: r.data.codeUrl,
  })),
};

// Build the system prompt with clearer formatting
const projectsList = contentIndex.projects
  .map(p => `- ID: ${p.id}
  Name: "${p.title}"
  Description: ${p.description}
  Technologies: ${p.tags.join(", ") || "not specified"}`)
  .join("\n\n");

const blogsList = contentIndex.blogs
  .map(b => `- ID: ${b.id}
  Title: "${b.title}"
  Description: ${b.description}`)
  .join("\n\n");

const researchList = contentIndex.research
  .map(r => `- ID: ${r.id}
  Paper: "${r.title}"
  Authors: ${r.authors}
  Venue: ${r.venue}`)
  .join("\n\n");

const systemPrompt = `You are Aniruddh's portfolio assistant. Answer questions using ONLY the information here. Be concise.

ANIRUDDH SRIRAM
- Software Engineer and NLP Researcher at UT Austin
- Member of TAUR lab, working on NLP and fact-checking with Dr. Greg Durrett

WORK EXPERIENCE:
- Voleon (SWE Intern, Summer 2023): Built ETL pipelines, REST backend in Python, Bloomberg DataLicense integration, achieved 10.4x speedup
- Bloomberg (SWE Intern, Summer 2022): Apache Spark dynamic resource allocation in Kubernetes, 59% speedup on validation jobs
- DevRev (SWE & ML Intern, Summer 2021): Built word2vec models in Python, trained PyTorch neural networks for GitHub issue assignment
- Cornerstone (Co-Founder & CTO, Dec 2021+): Built mobile app with React Native frontend, Golang and MongoDB backend

PERSONAL PROJECTS:
${projectsList}

RESEARCH PAPERS:
${researchList}

BLOG POSTS:
${blogsList}

RULES:
1. Only discuss information provided above
2. For projects/papers/blogs, use [[ID]] to create links (e.g., "See [[P1]]")
3. Never invent or make up projects
4. Keep answers brief`;
---

<div class="chat-container">
  <div class="terminal-input-container mb-4">
    <div class="flex items-center gap-2 font-mono text-base">
      <span class="zag-muted zag-transition select-none">&gt;</span>
      <input
        type="text"
        id="chat-input"
        placeholder="ask me anything..."
        class="flex-1 bg-transparent zag-text zag-transition outline-none border-none"
        autocomplete="off"
      />
    </div>
    <div class="flex justify-between items-center mt-2">
      <p id="status" class="text-xs zag-muted zag-transition font-mono"></p>
      <p class="text-xs zag-muted zag-transition font-mono">AniruddhLM v1.0</p>
    </div>
  </div>

  <div id="response-container" class="hidden">
    <div class="zag-border-t pt-4">
      <div id="response-content" class="response-text max-w-none font-mono text-sm leading-relaxed">
      </div>
    </div>
  </div>
</div>

<!-- Pass data to client-side JS -->
<script id="content-data" type="application/json" set:html={JSON.stringify(contentIndex)} />
<script id="system-prompt" type="text/plain" set:html={systemPrompt} />

<script>
  import { CreateMLCEngine } from "@mlc-ai/web-llm";
  import { marked } from "marked";

  // Configure marked for safe rendering
  marked.setOptions({
    breaks: true,
    gfm: true,
  });

  // Load content data and system prompt from embedded scripts
  const contentData = JSON.parse(document.getElementById("content-data")!.textContent || "{}");
  const systemPrompt = document.getElementById("system-prompt")!.textContent || "";

  // Build a lookup map for quick ID -> content resolution
  type ContentItem = { id: string; title: string; url?: string; paperUrl?: string };
  const contentMap = new Map<string, ContentItem>();
  
  contentData.projects?.forEach((p: ContentItem) => contentMap.set(p.id, p));
  contentData.blogs?.forEach((b: ContentItem) => contentMap.set(b.id, b));
  contentData.research?.forEach((r: ContentItem) => contentMap.set(r.id, r));

  // Post-process response to convert [[ID]] to actual links
  function processPortfolioLinks(html: string): string {
    // Match [[P1]], [[B2]], [[R3]] etc.
    return html.replace(/\[\[([A-Z]\d+)\]\]/g, (match, id) => {
      const item = contentMap.get(id);
      if (!item) return match;
      
      // For research papers, use paperUrl; for others use internal url
      const url = item.url || item.paperUrl || "#";
      const isExternal = url.startsWith("http");
      const target = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
      
      return `<a href="${url}"${target} class="portfolio-link">${item.title}</a>`;
    });
  }

  const MODEL_ID = "Phi-3.5-mini-instruct-q4f16_1-MLC";
  
  let engine: any = null;
  let isLoading = false;
  let enginePromise: Promise<any> | null = null;

  const input = document.getElementById("chat-input") as HTMLInputElement;
  const status = document.getElementById("status") as HTMLSpanElement;
  const responseContainer = document.getElementById("response-container") as HTMLDivElement;
  const responseContent = document.getElementById("response-content") as HTMLDivElement;

  const initProgressCallback = (progress: { text: string; progress: number }) => {
    status.textContent = progress.text;
  };

  async function initEngine() {
    if (engine) return engine;
    if (enginePromise) return enginePromise;
    
    isLoading = true;
    status.textContent = "Loading model...";
    
    enginePromise = CreateMLCEngine(MODEL_ID, {
      initProgressCallback,
    });
    
    try {
      engine = await enginePromise;
      status.textContent = "Ready";
      setTimeout(() => {
        status.textContent = "";
      }, 2000);
    } catch (error) {
      console.error("Failed to load model:", error);
      status.textContent = "Failed to load model";
      enginePromise = null;
      throw error;
    } finally {
      isLoading = false;
    }
    
    return engine;
  }

  // Start loading model in the background immediately
  // Model files are cached in IndexedDB, so navigating away and back is fine
  initEngine().catch(() => {
    // Silently handle - user will see error when they try to use it
  });

  async function handleSubmit() {
    const query = input.value.trim();
    if (!query) return;

    // Show response container and clear previous response
    responseContainer.classList.remove("hidden");
    responseContent.innerHTML = "";
    
    // Disable input while processing
    input.disabled = true;
    status.textContent = "Thinking...";

    try {
      // Initialize engine if not already done
      const eng = await initEngine();

      const messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: query },
      ];

      // Stream the response
      const chunks = await eng.chat.completions.create({
        messages,
        temperature: 0.7,
        stream: true,
        stream_options: { include_usage: true },
      });

      let reply = "";
      for await (const chunk of chunks) {
        const delta = chunk.choices[0]?.delta?.content || "";
        reply += delta;
        // Render markdown and process portfolio links
        const htmlContent = marked.parse(reply) as string;
        responseContent.innerHTML = processPortfolioLinks(htmlContent);
      }

      status.textContent = "";
    } catch (error) {
      console.error("Error:", error);
      responseContent.innerHTML = `<p class="error-text">Error: ${error instanceof Error ? error.message : "Something went wrong"}</p>`;
      status.textContent = "";
    } finally {
      input.disabled = false;
      input.focus();
    }
  }

  // Handle Enter key
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  });

  // Focus input on load
  input.focus();
</script>

<style>
  .chat-container {
    width: 100%;
  }

  .terminal-input-container {
    border-bottom: 1px solid var(--color-zag-dark-muted);
    padding-bottom: 0.5rem;
  }
  :global(.dark) .terminal-input-container {
    border-bottom-color: var(--color-zag-light-muted);
  }

  #chat-input {
    caret-color: currentColor;
  }

  #chat-input::placeholder {
    opacity: 0.4;
    font-style: italic;
  }

  /* Response text - respects light/dark mode */
  .response-text {
    color: var(--color-zag-dark);
  }
  :global(.dark) .response-text {
    color: var(--color-zag-light);
  }

  .error-text {
    color: #ef4444;
  }

  /* Markdown content styling */
  #response-content :global(p) {
    margin-bottom: 1em;
  }

  #response-content :global(p:last-child) {
    margin-bottom: 0;
  }

  #response-content :global(code) {
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-size: 0.9em;
    background-color: var(--color-zag-dark);
    color: var(--color-zag-light);
  }
  :global(.dark) #response-content :global(code) {
    background-color: var(--color-zag-light);
    color: var(--color-zag-dark);
  }

  #response-content :global(pre) {
    padding: 1em;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1em 0;
    background-color: var(--color-zag-dark);
    color: var(--color-zag-light);
  }
  :global(.dark) #response-content :global(pre) {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--color-zag-light);
  }

  #response-content :global(pre code) {
    padding: 0;
    background: none;
    color: inherit;
  }

  #response-content :global(ul),
  #response-content :global(ol) {
    margin: 1em 0;
    padding-left: 1.5em;
  }

  #response-content :global(li) {
    margin: 0.5em 0;
  }

  #response-content :global(h1),
  #response-content :global(h2),
  #response-content :global(h3),
  #response-content :global(h4) {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
  }

  #response-content :global(blockquote) {
    border-left: 3px solid currentColor;
    padding-left: 1em;
    margin: 1em 0;
    opacity: 0.8;
  }

  #response-content :global(a) {
    text-decoration: underline;
    color: var(--color-zag-accent-dark);
  }
  :global(.dark) #response-content :global(a) {
    color: var(--color-zag-accent-light);
  }

  #response-content :global(a:hover) {
    text-decoration: none;
  }

  /* Portfolio link styling */
  #response-content :global(.portfolio-link) {
    font-weight: 500;
  }

  #response-content :global(strong) {
    font-weight: 600;
  }
</style>
